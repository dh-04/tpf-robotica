
\subsection{Comportamientos e implementaciones}
\label{comportamientos}

Una vez que decidimos utilizar la arquitectura explicada en la secci\'on \ref{arq_prop}
para nuestro proyecto, tuvimos que analizar:
\begin{itemize}
\item{}Forma de implementaci\'on de la arquitectura en c\'odigo
\item{}Comportamientos a realizar
\item{}Ordenes de inhibici\'on y supresi\'on entre los mismos
\item{}Forma de implementaci\'on de los mismos
\item{}Orden de implementaci\'on
\end{itemize}

%Detallar que se hizo con cada item
Para implementar la arquitectura decidimos asignarle un $ID$ num\'erico diferente a cada comportamiento.
Tambi\'en tomamos la decisi\'on de elegir como comportamiento activo en el instante $t$,
aquel comportamiento que est\'e activo en ese instante y tenga mayor $ID$,
suprimiendo as\'i el resto de los comportamientos ( con un $ID$ menor ) que podr\'ian estar activos.

%Explicar como se relaciona el requerimiento (robot recolector de basura autonomo) con los comportamientos que pusimos
El requerimiento de este proyecto es la realizaci\'on de un robot aut\'onomo que recolecte
basura de su entorno din\'amico pero estructuralmente fijo. De aqu\'i se infieren algunos de los
comportamientos que debe tener el robot:
\begin{itemize}
	\item{\emph{Recolectar basura} (\ref{collect_garbage})}
	\item{\emph{Recargar bater\'ia} (\ref{recharge_battery}):} Por ser aut\'onomo, debe poder 
			ser capaz de recargarse s\'olo para poder continuar con su actividad.
	\item{\emph{Wandering} (\ref{wandering}):} El robot no es controlado por control, ya que
			es aut\'onomo, por lo que debe poder recorrer el entorno por s\'i mismo.
	\item{\emph{Evitamiento de obst\'aculos} (\ref{avoid_obstacles}):} Debido a la naturaleza del
			entorno, el robot debe ser capaz de navegar sin chocarse contra los l\'imites del entorno
			ni con las personas que circulan por el mismo.
\end{itemize}

El comportamiento de recolectar basura y el requerimiento de la autonom\'ia llevan a su vez
a la aparici\'on de m\'as comportamientos: \emph{Descargar basura} (\ref{unload_garbage})
e \emph{Ir hacia basura} (\ref{go_to_garbage}).
\\
La figura \ref{fig:architecture} muestra los comportamientos implementados y su orden de jerarqu\'ia.
Se puede ver que hay m\'as comportamientos de los detallados anteriormente. \'Esto se debi\'o a que la forma
en que se implementamos los comportamientos b\'asicos del robot nos requiri\'o el desarrollo
de comportamientos auxiliares.
\\
\begin{figure}[htp]
\begin{center}
\includegraphics[scale=0.5]{comportamientos/behavioursArchitecture.png}
\caption{Arquitectura de Comportamientos}
\label{fig:architecture}
\end{center}
\end{figure}
\\
Primero implementamos \emph{Wandering} debido a, en una primera aproximaci\'on, la sencillez
del mismo. Luego implementamos \emph{Evitamiento de obst\'aculos} para lograr que el robot pueda
navegar sin problemas por el arena. Como el comportamiento de recolectar e ir hacia la basura
dependend\'ia del m\'odulo de reconocimiento de objetos y el mismo estaba siendo desarrollado
en paralelo, se decidi\'o implementar el comportamiento de \emph{Recargar bater\'ia} y \emph{Descargar basura}.
Una vez que tuvimos la primera implementaci\'on funcional del reconomiento de objetos, procedimos a
desarrollar \emph{Ir hacia basura} y \emph{Recolectar Basura}.
\\
A continuaci\'on detallamos los comportamientos indicados en la figura \ref{fig:architecture},
as\'i como la implementaci\'on en \textit{pseudo-codigo} de los mismos y detalles tenidos
en cuenta para la realizaci\'on de los mismos.
%A continuacion vamos a explicar cada comportamiento.....

\subsubsection{Wandering}
\label{wandering}

\paragraph{Detalle del comportamiento} 
Por ser el comportamiento que menor jerarqu\'ia tiene (Ver \ref{fig:architecture}), es el \'unico
comportamiento que est\'a activado ante la ausencia de un est\'imulo, asegurandonos que siempre
haya por lo menos un comportamiento activo.
\\
En una primer aproximaci\'on de \emph{Wandering}, s\'olo nos preocupamos por ir hacia adelante
ya que eventualmente, el robot encuentra un obst\'aculo y realiza un giro cambiando la direcci\'on
del robot.
\\
Los resultados de la simulaci\'on nos indicaron que el robot no recorr\'ia ciertas zonas o las recorr\'ia
despu\'es de un largo tiempo, lo que nos llev\'o a un segundo approach. El mismo tiene en cuenta el hecho
de que el robot posee una c\'amara y por lo tanto se puede llevar un seguimiento de los lugares que m\'as
recientemente visit\'o o las zonas que hace mucho tiempo no visita.
\\
\'Este approach, en cierta forma, genera un modelo del mundo, un hecho que conflict\'ua con uno de
los principios propuestos a seguir en la secci\'on \ref{arq_prop}. Para minimizar el conflicto, decidimos
mantener al m\'inimo la informaci\'on almacenada para el funcionamiento del algoritmo, es decir, por cada
zona de arena s\'olo mantenemos el timestamp de la \'ultima vez que el robot la visit\'o.

\paragraph{Implementaci\'on del comportamiento}

La implementaci\'on del segundo approach, en \emph{pseudo-c\'odigo} es la siguiente:
\begin{verbatim}
por cada paso
    zona = pedir_zona_vista(camara)
    marcar_zona_como_vista(modelodelmundo,zona)
    ultimazonavisitada = pedir_ultima_zona_visitada(modelodelmundo)
    velocidades = calcular_velocidades_de_ruedas(ultimazonavisitada)
    poner_velocidades_en_ruedas(velocidades)
\end{verbatim}
Para obtener la zona vista por la c\'amara, necesitamos de la altura $c_h$ a la cual est\'a ubicada
la c\'amara en el robot, el campo de visi\'on (de ahora en adelante \emph{Field of View o FOV})
horizontal $FOV_h$ o vertical $FOV_v$ y el \'angulo de inclinaci\'on de la c\'amara $ac$. Viendo la figura
\ref{fig:angleCamera} podemos ver que:

\begin{figure}[htp]
\begin{center}
\includegraphics{comportamientos/angleCamera.png}
\caption{Diagrama de posici\'on de la c\'amara}
\label{fig:angleCamera}
\end{center}
\end{figure}

\begin{eqnarray}
ac + \frac{FOV_v}{2} + \theta = \frac{\pi}{2}\\
\gamma + FOV_v + \theta = \frac{\pi}{2}\\
\tan(\gamma) = \frac{d}{c_h}\\
\tan(\gamma+FOV_v) = \frac{d+h}{c_h}
\end{eqnarray}

%En caso de no disponer del $FOV_v$, el mismo se puede obtener de:
%\begin{equation}
%FOV_v = \atan(\frac{ \tan(\frac{FOV_h}{2}) * height}{width} * 2)\\
%\end{equation}
Organizando las ecuaciones, podemos deducir que:

\begin{eqnarray}
\gamma = \frac{\pi}{2} + ac - \frac{FOV_v}{2}\\
\label{eqn:distance_d}
d = \tan(\gamma) * c_h \\
\label{eqn:distance_dh}
d+h = \tan(\gamma+FOV_v) * c_h
\end{eqnarray}

Por lo que obtenemos el \'angulo hasta el inicio de la im\'agen de la c\'amara $\gamma$ y como consecuencia,
la distancia $d$ desde la posici\'on de la c\'amara hasta el inicio de la im\'agen y $d+h$,
la distancia desde la posici\'on de la c\'amara hasta el final de la im\'agen. Usando \'estos
datos, la posici\'on del robot $P$ y bas\'andonos en la figura \ref{fig:zoneCamera}, podemos obtener
los puntos $A$, $B$, $C$ y $D$ del trapezoide que determina la zona que ve la c\'amara.

\begin{figure}[htp]
\begin{center}
\includegraphics[scale=0.5]{comportamientos/rectangleWander.png}
\caption{Zona vista por la c\'amara}
\label{fig:zoneCamera}
\end{center}
\end{figure}

\subsubsection{Enfocar Basura}
\label{focus_garbage}
Una vez que el m\'odulo de detecci\'on de objetos reconoce algo como basura, hay que elegir
la forma en que se va a la basura. En la figura \ref{fig:papproachgoto} se puede ver un
primer approach de hacer \'esto. Consiste en primero enfocar la basura de forma tal que
la misma quede en el centro de la imagen de la c\'amara. De aqu\'i surge el comportamiento
\emph{Enfocar Basura}.
\\
Un segundo approach (Figura \ref{fig:sapproachgoto}) no consiste en enfocar la basura,
sino que se idea un arco hacia la misma. \'Esto requiere que se seteen las velocidades
correspondientes a las ruedas de forma tal que la trayectoria del robot describa dicho
arco. Con este segundo approach no existir\'ia el comportamiento que se est\'a describiendo.
\\
Dado que el primer approach es levemente m\'as simple de implementar, y teniendo en cuenta el
principio enunciado en la secci\'on \ref{arq_prop} \emph{"La simplicidad es una virtud"},
elegimos implementar el mismo, a pesar de tener un posible inconveniente, como se puede
ver en la figura \ref{fig:papproachgotoproblem}.
\\
Cuando hay una basura en alguna esquina
superior de la imagen de la c\'amara, y el robot gira sobre s\'i mismo para enfocarla,
la basura puede llegar a perderse por el fondo de la imagen. \'Esto se debe a que la distancia
hacia dichas esquinas es mayor a la distancia hacia el centro del borde superior de la imagen
(Ver figura \ref{fig:zoneCamera}). Decimos que es un "posible" problema, ya que una vez que se
pierde de vista la basura, el robot no enfocar\'a m\'as debido a que el est\'imulo desapareci\'o,
pero si luego se dirige hacia adelante (por la activaci\'on de alg\'un otro comportamiento), 
la basura volver\'a a aparecer en la imagen, sin desaprovechar la oportunidad de recogerla.

\begin{figure}[htp]
\begin{center}
\includegraphics[scale=0.5]{comportamientos/basura.png}
\includegraphics[scale=0.5]{comportamientos/basuraenfocada.png}
\caption{Primer approach de ir a la basura}
\label{fig:papproachgoto}
\end{center}
\end{figure}

\begin{figure}[htp]
\begin{center}
\includegraphics[scale=0.5]{comportamientos/basuraAlt.png}
\caption{Segundo approach de ir a la basura}
\label{fig:sapproachgoto}
\end{center}
\end{figure}

\begin{figure}[htp]
\begin{center}
\includegraphics[scale=0.3]{comportamientos/esquina.png}
\includegraphics[scale=0.3]{comportamientos/frentemuylejos.png}
\includegraphics[scale=0.3]{comportamientos/frentelejos.png}
\caption{Posible inconveniente con el primer approach de ir a la basura}
\label{fig:papproachgotoproblem}
\end{center}
\end{figure}

\paragraph{Detalle del comportamiento}
El approach elegido, entonces, se puede describir como:
\begin{itemize}
\item Si la basura est\'a a la izquierda de la im\'agen, se debe girar hacia la izquierda
\item Si la basura est\'a a la derecha de la im\'agen, se debe girar hacia la derecha
\item Si la basura est\'a en el centro, ya est\'a enfocada
\end{itemize}

%En el caso que haya m\'as de una basura elegimos la m\'as cercana, usando c\'alculos
%detallados a continuaci\'on.
\paragraph{Implementaci\'on del comportamiento}
El comportamiento sigue el siguiente \emph{pseudo-codigo}:
\begin{verbatim}
por cada paso
    lista_de_basuras = obtener_lista_de_basuras(modulodereconocimiento)
    basura_mas_cercana = elijo_basura_mas_cercana(lista_de_basuras)
    angulo_a_basura = obtener_angulo(basura_mas_cercana)
    velocidad = VELOCIDAD_BASE * ( abs(angulo_a_basura) / (PI/2) ) + VELOCIDAD_BASE_MINIMA
    si angulo_a_basura < 0 entonces
        veloc_izq = -velocidad
        veloc_der = velocidad
    sino
        veloc_izq = velocidad
        veloc_der = -velocidad
    fin_si
    poner_velocidades_en_ruedas(veloc_izq,veloc_der)
\end{verbatim}

Se puede ver que la velocidad de giro del robot es proporcional al \'angulo que hay
hacia la basura, logrando enfocar m\'as r\'apido cuando el \'angulo es mayor y tener
mayor precisi\'on cuando el \'angulo es m\'as chico, adem\'as de tener mayor rapidez
de enfoque y precisi\'on que si la velocidad de giro fuera constante.
\\
TODO HACER REFERENCIA A LA SECCION DE VISION CON OBTENERLISTADEBASURAS

%%Para obtener el \'angulo y distancia hacia una basura....
%%pasamos de una posicion (x,y) en la imagen a una posicion
%(x,z) en el mundo. teniendo nuestra posicion P, podemos
%calcular la distancia y el angulo
\subsubsection{Ir a Basura}
\label{go_to_garbage}
Luego de la elecci\'on de la forma que se resuelve la situaci\'on de encontrar una
basura (ver \ref{focus_garbage}), el comportamiento de ir a basura es trivial, ya
que la basura, luego de ser enfocada, est\'a delante del robot y lo \'unico que
basta es ir hacia adelante.

\paragraph{Detalle del comportamiento}
El est\'imulo necesario para que este comportamiento est\'e presente est\'a
dado por dos condiciones:
\begin{enumerate}
\item El m\'etodo de reconociemiento de objetos reconoci\'o una basura
\item La basura se encuentra en un entorno del medio horizontal de la imagen de la c\'amara
\end{enumerate}
\paragraph{Implementaci\'on del comportamiento}
\begin{verbatim}
por cada paso
    distancia = obtener_distancia_a_basura(modulodereconocimiento)
    coeff = (distancia - DIST_MIN)/(DIST_MAX - DIST_MIN)
    veloc_der = VELOCIDAD_MIN*(1 - coeff) + coeff*VELOCIDAD_MAX
    veloc_izq = veloc_der
    poner_velocidades_en_ruedas(veloc_izq,veloc_der)
\end{verbatim}

Al igual que en la implementaci\'on del comportamiento \ref{focus_garbage},
las velocidades que se le otorgan a las ruedas dependen de la distancia
hacia la basura, de forma tal que si una basura est\'a muy lejos, la velocidad
sea mayor y a medida que se va acercando, vaya disminuyendo linealmente.

Dado que la basura se encuentra en un entorno del eje Y en la imagen (Ver figura
\ref{fig:image_coord_conv}b) cometemos un error muy peque\~no al estimar la distancia
a la basura como si estuviera sobre el mismo (asumiendo que la coordenada X de la
basura en la imagen es 0).

Como muestran las figuras \ref{fig:image_coord_conv} y \ref{fig:angleCamera},
el \'angulo vertical hacia el punto m\'as alto de la imagen $(0,h)$ es 
$\gamma+FOV_v$ y hacia el m\'as bajo, $(0,0)$, el \'angulo es $\gamma$.
De las ecuaciones \eqref{eqn:distance_d} y \eqref{eqn:distance_dh} sabemos
las distancias a los puntos $(0,0)$ (DIST\_MIN) y $(0,h)$ (DIST\_MAX). 
Entonces, para obtener la distancia $dy$ hacia el punto $(0,y)$ basta con
calcular:
\begin{eqnarray}
y_{angle} = FOV_v * \frac{y}{h} \\
dy = \tan(\gamma + y_{angle}) * c_h \\
\end{eqnarray}

donde $y_{angle}$ es la proporci\'on de $FOV_v$ hacia $y$.
\begin{figure}[htp]
\begin{center}
\includegraphics[scale=0.5]{comportamientos/imageCoordsConvertion.png}
\caption{Conversi\'on de coordenadas de imagen de c\'amara}
\label{fig:image_coord_conv}
\end{center}
\end{figure}

\subsubsection{Recolectar Basura}
\label{collect_garbage}
\paragraph{Detalle del comportamiento}
\paragraph{Implementaci\'on del comportamiento}

\subsubsection{Ir a zona de descarga de basura}
\label{go_to_unload_zone}

\paragraph{Buscar l\'inea}
\label{find_line}
\subparagraph{Detalle del comportamiento}
\subparagraph{Implementaci\'on del comportamiento}

\paragraph{Entrar a l\'inea}
\label{enter_line}
\subparagraph{Detalle del comportamiento}
\subparagraph{Implementaci\'on del comportamiento}

\paragraph{Seguir l\'inea}
\label{follow_line}
\subparagraph{Detalle del comportamiento}
\subparagraph{Implementaci\'on del comportamiento}

\subsubsection{Descargar Basura}
\label{unload_garbage}
\paragraph{Detalle del comportamiento}
\paragraph{Implementaci\'on del comportamiento}

\subsubsection{Ir a base de recarga de bater\'ia}
\label{go_to_recharge}
\paragraph{Detalle del comportamiento}
\paragraph{Implementaci\'on del comportamiento}

\subsubsection{Cargar Bater\'ia}
\label{recharge_battery}
\paragraph{Detalle del comportamiento}
\paragraph{Implementaci\'on del comportamiento}

\subsubsection{Recalibrarse}
\label{recalibrate}
\paragraph{Detalle del comportamiento}
\paragraph{Implementaci\'on del comportamiento}

\subsubsection{Evitar Obst\'aculos}
\label{avoid_obstacles}
\paragraph{Detalle del comportamiento}
\paragraph{Implementaci\'on del comportamiento}

\subsubsection{Salir de situaciones no deseadas}
\label{out_of_unwanted_situations}
\paragraph{Detalle del comportamiento}
\paragraph{Implementaci\'on del comportamiento}

