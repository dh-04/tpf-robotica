// Class automatically generated by Dev-C++ New Class wizard

#include <protocol/handlers/BatteryBoardPacketHandler.h> // class's header file
#include <protocol/packets/BatteryPacket.h>
#include <math.h>

namespace protocol {
namespace handlers {

// class constructor
BatteryBoardPacketHandler::BatteryBoardPacketHandler(PacketServer * ps, char groupid, char boardid)
{
	this->groupid = groupid;
	this->boardid = boardid;
	this->ps = ps;
	this->currentValue = 0;
	this->full = false;
	this->empty = false;
}

// class destructor
BatteryBoardPacketHandler::~BatteryBoardPacketHandler()
{
	// insert your code here
}

void BatteryBoardPacketHandler::handlePacket(Packet * p){
	packets::BatteryPacket * bp = new packets::BatteryPacket(groupid,boardid);
	bp->analysePacket(p);
	
	if ( bp->getCommand() == CMD_BATTERY_VALUE ){
		short value = bp->getBatteryValue();
		// TODO convert from short to double
		// Lock Mutex
		this->currentValue = value;
		// Release Mutex
	}
	if ( bp->isBatteryFull() ){
		// TODO convert from short to double
		// Lock Mutex
		this->full = true;
		// Release Mutex
	}
	if ( bp->isBatteryEmpty() ){
		// TODO convert from short to double
		// Lock Mutex
		this->empty = true;
		// Release Mutex
	}
}

void BatteryBoardPacketHandler::enable(){
 	packets::BatteryPacket * p = new packets::BatteryPacket(groupid,boardid);
	p->enable();
	p->prepareToSend();
	this->ps->sendPacket(p);
}

void BatteryBoardPacketHandler::disable(){
 	packets::BatteryPacket * p = new packets::BatteryPacket(groupid,boardid);
	p->disable();
	p->prepareToSend();
	this->ps->sendPacket(p);
}

double BatteryBoardPacketHandler::getValue(){
 	packets::BatteryPacket * p = new packets::BatteryPacket(groupid,boardid);
	p->senseBattery();
	p->prepareToSend();
	this->ps->sendPacket(p);
	return this->currentValue;
}

bool BatteryBoardPacketHandler::isFull(){
	// Lock mutex
	bool full = this->full;
	// Release mutex
	return full;
}

void BatteryBoardPacketHandler::setEmptyBias(double bias){
	packets::BatteryPacket * p = new packets::BatteryPacket(groupid,boardid);
	// TODO convert from double to char
	p->setBatteryEmptyThreshold(bias);
	p->prepareToSend();
	this->ps->sendPacket(p);
}

bool BatteryBoardPacketHandler::isEmpty(){
	// Lock mutex
	bool empty = this->empty;
	// Release mutex
	return empty;
}

void BatteryBoardPacketHandler::setFullBias(double bias){
	packets::BatteryPacket * p = new packets::BatteryPacket(groupid,boardid);
	// TODO convert from double to char
	p->setBatteryFullThreshold(bias);
	p->prepareToSend();
	this->ps->sendPacket(p);
}

}
}

